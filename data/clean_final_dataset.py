import re
import os
from tqdm import tqdm  # –î–ª—è –∫—Ä–∞—Å–æ—Ç—ã –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
INPUT_FILE = "final_dataset_ready.txt"
OUTPUT_FILE = "final_dataset_clean.txt"


def advanced_clean_text(text):
    if not isinstance(text, str):
        return ""

    # 1. –£–¥–∞–ª—è–µ–º –Ω–µ–≤–∏–¥–∏–º—ã–π –º—É—Å–æ—Ä
    text = text.replace("\ufeff", "").replace("\u200b", "")

    # 2. –£–¥–∞–ª—è–µ–º PUA-—Å–∏–º–≤–æ–ª—ã (Private Use Area)
    # –≠—Ç–æ —É–±–µ—Ä–µ—Ç –≤–∞—à–∏ \uf074, \uf13f, \uf2d1 –∏ –ø—Ä–æ—á–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã —à—Ä–∏—Ñ—Ç–æ–≤
    text = re.sub(r"[\ue000-\uf8ff]", "", text)

    # 3. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≥–æ–º–æ–≥–ª–∏—Ñ–æ–≤ (–õ–∞—Ç–∏–Ω–∏—Ü–∞ -> –ö–∏—Ä–∏–ª–ª–∏—Ü–∞)
    # –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º "–ª–∂–µ-—Ä—É—Å—Å–∫–∏–µ" –±—É–∫–≤—ã –≤ –Ω–∞—Å—Ç–æ—è—â–∏–µ
    replacements = {
        "A": "–ê",
        "a": "–∞",
        "B": "–í",
        "E": "–ï",
        "e": "–µ",
        "K": "–ö",
        "k": "–∫",
        "M": "–ú",
        "H": "–ù",  # H –ª–∞—Ç–∏–Ω—Å–∫–∞—è -> –ù –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∞—è
        "O": "–û",
        "o": "–æ",
        "P": "–†",
        "p": "—Ä",
        "C": "–°",
        "c": "—Å",
        "T": "–¢",
        "y": "—É",  # y –ª–∞—Ç–∏–Ω—Å–∫–∞—è -> —É –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∞—è
        "X": "–•",
        "x": "—Ö",
    }
    for lat, cyr in replacements.items():
        text = text.replace(lat, cyr)

    # 4. –£–¥–∞–ª—è–µ–º –Ω–∞–¥—Å—Ç—Ä–æ—á–Ω—ã–µ –∑–Ω–∞–∫–∏ (—Ç–∏—Ç–ª–∞, —É–¥–∞—Ä–µ–Ω–∏—è, –∑–≤–∞—Ç–µ–ª—å—Ü–∞)
    # –î–∏–∞–ø–∞–∑–æ–Ω \u0300-\u036f (–¥–∏–∞–∫—Ä–∏—Ç–∏–∫–∞) –∏ \u0483-\u0489 (—Ç–∏—Ç–ª–∞)
    # –≠—Ç–æ –ø—Ä–µ–≤—Ä–∞—Ç–∏—Ç "—Å–Ω“É–∞" –≤ "—Å–Ω–∞", "—Ü—Ä“É—å" –≤ "—Ü—Ä—å"
    text = re.sub(r"[\u0300-\u036f\u0483-\u0489]", "", text)

    # 5. –°—Ö–ª–æ–ø—ã–≤–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
    text = re.sub(r"\s+", " ", text).strip()

    return text


print(f">>> üßº –ù–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞–ª—å–Ω—É—é —É–±–æ—Ä–∫—É —Ñ–∞–π–ª–∞ {INPUT_FILE}...")

if not os.path.exists(INPUT_FILE):
    print(
        f"‚ùå –û—à–∏–±–∫–∞: –§–∞–π–ª {INPUT_FILE} –Ω–µ –Ω–∞–π–¥–µ–Ω! –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –ø—Ä–µ–¥—ã–¥—É—â–∏–º —Å–∫—Ä–∏–ø—Ç–æ–º."
    )
else:
    with open(INPUT_FILE, "r", encoding="utf-8") as f_in, open(
        OUTPUT_FILE, "w", encoding="utf-8"
    ) as f_out:

        lines = f_in.readlines()
        cleaned_count = 0

        for line in tqdm(lines, desc="–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç—Ä–æ–∫"):
            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ —Ä–∞–∑–¥–µ–ª–æ–≤ (—á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É)
            if line.startswith("---"):
                f_out.write(line)
                continue

            original = line
            cleaned = advanced_clean_text(line)

            # –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ –ø—É—Å—Ç–∞—è –ø–æ—Å–ª–µ —á–∏—Å—Ç–∫–∏ - –∑–∞–ø–∏—Å—ã–≤–∞–µ–º
            if len(cleaned) > 1:
                f_out.write(cleaned + "\n")
                cleaned_count += 1

    print(f"\n‚úÖ –ì–û–¢–û–í–û! –ß–∏—Å—Ç—ã–π —Ñ–∞–π–ª: {OUTPUT_FILE}")
    print(f"üìä –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ —Å—Ç—Ä–æ–∫: {cleaned_count}")
    print("–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –æ–±—É—á–∞—Ç—å —Ç–æ–∫–µ–Ω–∏–∑–∞—Ç–æ—Ä –∏ –º–æ–¥–µ–ª—å –∑–∞–Ω–æ–≤–æ!")
